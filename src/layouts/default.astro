---
import Base from "./minimal.astro";
import Logo from "$/assets/logo.svg";

import Cmdk from "$/cmdk/cmdk.svelte";
import OpenCMDK from "$/cmdk/openButton.svelte";

import { ExternalLink } from "lucide-svelte";

const { class: className, title, description } = Astro.props;
---

<Base class={className} title={title} description={description}>
  <header class="fixed top-6 left-1/2 -translate-x-1/2 z-50000 flex">
    <nav
      class="flex w-fit ml-auto gap-4 pr-4 pl-2 py-2 rounded-xl border border-grey-500 dark:border-grey-100/20 backdrop-blur-md bg-grey-50/20 hover:bg-grey-50/30 dark:bg-grey-950/20 dark:hover:bg-grey-950/30 text-sm items-center justify-center"
    >
      <a
        href="/"
        class="group flex items-center justify-center gap-1.5 hover:text-old-rose transition-colors"
      >
        <Logo
          class="size-6 rounded-sm group-hover:scale-110 transition-transform group-active:scale-90"
        />
        Jafu.py
        <span class="sr-only">Home</span>
      </a>
      <a href="/about" class="hover:text-old-rose transition-colors">About</a>
      <a href="/writing" class="hover:text-old-rose transition-colors"
        >Writing</a
      >
      <a
        href="mailto:jacob@jafupy.com"
        class="group relative hover:text-old-rose transition-colors flex items-center justify-center gap-2"
        >Contact
        <ExternalLink class="size-3.75" />
        <span
          id="contact_tooltip"
          class="invisible select-text pointer-events-auto not-group-hover:delay-200 overflow-visible group-hover:visible absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-grey-900 text-grey-100 text-sm px-4 py-1.5 rounded-lg border border-grey-300/20 whitespace-nowrap before:content-[''] before:absolute before:bottom-full before:translate-y-1/2 before:-z-2 before:left-1/2 before:-translate-x-1/2 before:border-l before:border-t before:border-grey-300/20 before:bg-grey-900 before:rounded-tl-xs before:size-2 before:rotate-45"
        >
          hello@jafupy.com
        </span>
      </a>
      <span class="block w-px h-4 bg-grey-300 mx-2"></span>
      <OpenCMDK client:load />
    </nav>
  </header>
  <slot />
  <Cmdk client:load="svelte" />
</Base>

<script is:inline>
  document.querySelector("#contact_tooltip").addEventListener("click", (e) => {
    e.stopPropagation();
    e.preventDefault();
  });
</script>

<script>
  // Alternative version with even better performance using transform instead of CSS custom properties
  function grid({ strength = 20, easing = 0.05, element = document.body }) {
    let target = { x: 0, y: 0 };
    let current = { x: 0, y: 0 };
    let rafID = -Infinity;
    let isAnimating = false;

    const threshold = 0.001;
    const invStrength = -strength;

    function handleMouseMove(e: MouseEvent) {
      const { innerWidth, innerHeight } = window;
      target.x = (e.clientX / innerWidth - 0.5) * invStrength;
      target.y = (e.clientY / innerHeight - 0.5) * invStrength;

      if (!isAnimating) {
        isAnimating = true;
        rafID = requestAnimationFrame(update);
      }
    }

    function update() {
      const deltaX = target.x - current.x;
      const deltaY = target.y - current.y;

      if (Math.abs(deltaX) > threshold || Math.abs(deltaY) > threshold) {
        current.x += deltaX * easing;
        current.y += deltaY * easing;

        // Using transform is more performant than CSS custom properties
        element.style.setProperty(
          "--grid-offset-x",
          `${current.x.toFixed(2)}px`,
        );
        element.style.setProperty(
          "--grid-offset-y",
          `${current.y.toFixed(2)}px`,
        );

        rafID = requestAnimationFrame(update);
      } else {
        isAnimating = false;
        current.x = target.x;
        current.y = target.y;

        element.style.setProperty(
          "--grid-offset-x",
          `${target.x.toFixed(2)}px`,
        );
        element.style.setProperty(
          "--grid-offset-y",
          `${target.y.toFixed(2)}px`,
        );
      }
    }

    function cleanup() {
      window.removeEventListener("mousemove", handleMouseMove);
      if (rafID !== -Infinity) {
        cancelAnimationFrame(rafID);
      }
      isAnimating = false;
      element.style.transform = "";
    }

    window.addEventListener("mousemove", handleMouseMove, { passive: true });

    return cleanup;
  }

  grid({});
</script>
